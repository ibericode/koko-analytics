#!/usr/bin/env php
<?php

/**
 * Checks all PHP files in this project recursively
 * and passes them to PHP's built-in linter.
 *
 * If the output contains "deprecated", the final status code will be 1.
 */

$global_exit_code = 0;

$directory = new \RecursiveDirectoryIterator(".", \FilesystemIterator::FOLLOW_SYMLINKS);
$filter = new \RecursiveCallbackFilterIterator($directory, function ($current, $key, $iterator) {
  // Skip hidden files and directories.
  if (strpos($current->getFilename(), '.') === 0) {
    return false;
  }

  // Skip node_modules and vendor directory
  if ($current->isDir()) {
    return ! in_array($current->getFilename(), ['vendor', 'node_modules']);
  }

  return $current->getExtension() == "php";
});
$iterator = new \RecursiveIteratorIterator($filter);

foreach ($iterator as $file) {
  $exit_code = 0;
  $output = [];
  exec("php --define error_reporting=-1 -l {$file->getPathname()}", $output, $exit_code);
  $output = join("\n", $output);
  echo $output . "\n";

  if ($exit_code || strpos($output, 'Deprecated') !== false) {
    $global_exit_code = 1;
  }
}

exit($global_exit_code);
